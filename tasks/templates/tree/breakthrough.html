{% extends 'base.html' %}
{% load render_assets model_presenters humanize %}

{% block body_class %}page-daily{% endblock %}

{% block title %}
    Your {{ year }} breakthrough
{% endblock %}

{% block content %}
<div class="container">
    <form method="post" action="">
        {% csrf_token %}
        {{ form.id }}
        <main class="breakthrough" id="year" data-year="{{ year }}">
            <header>
                <div class="year-navigation">
                    <a href="{% url 'breakthrough' year=year|add:'-1' %}{% if review_mode %}?review=1{% endif %}" class="nav-link prev-year">&larr; {{ year|add:'-1' }}</a>
                    {% if review_mode %}
                        <a href="{% url 'breakthrough' year=year %}" class="nav-link review-toggle">Exit Review</a>
                    {% else %}
                        <a href="{% url 'breakthrough' year=year %}?review=1" class="nav-link review-toggle">Review</a>
                    {% endif %}
                    <a href="{% url 'breakthrough' year=year|add:'1' %}{% if review_mode %}?review=1{% endif %}" class="nav-link next-year">{{ year|add:'1' }} &rarr;</a>
                </div>
                <h1>Your {{ year }} breakthrough</h1>

                <button type="submit">Save</button>
            </header>

            <div class="column1">
                <section class="menu">{% include "menu.html" %}</section>

                <section class="breakthrough-summary">
                    <h2>Your {{ last_year }} Timeline</h2>
                    {% if breakthrough_habits.count > 0 %}
                    
                    {% regroup breakthrough_habits by published|date:"F Y" as grouped_habits %}
                    <ul class="breakthrough-timeline">
                        {% for month, habits in grouped_habits|missing_months %}
                            {% if habits %}
                                <li>
                                    <strong>{{ month }}</strong>
                                    <ul>
                                        {% for tracked in habits %}
                                            <li>
                                                <a 
                                                    href="{% url 'public-diary-archive-month' tracked.published.year tracked.published.month %}#{{ tracked.published|date:'b-d' }}"
                                                    class="event-day"
                                                >{{ tracked.published|date:'d'|ordinal }}</a>
                                                {{ tracked|habit_without_name }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% else %}
                                <li class="missing-month"><strong>{{ month }}</strong></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                    {% endif %}
                </section>

                <section class="areas-of-concern">
                    <h2>Your main areas of concern / discomfort</h2>
                    <p>List areas of your life giving you the most discomfort, anxiety or pain.</p>
                    {{ form.areas_of_concern }}
                    <p class="meta">Then, prioritize one that is most important to you and would make your breakthrough this year.</p>
                </section>

            </div>

            <div class="column2">

                <section class="word-of-the-year">
                    <h2>Your theme of the year</h2>
                    <p>Choose a word or phrase that would best describe your year.</p>
                    {{ form.theme }}
                    <p class="meta">Make sure it <strong>resonates</strong> with you <br>
                        and that you are <strong>constantly reminding</strong> yourself about it.
                    </p>
                </section>

                <section class="breakthrough-outcomes">
                    <h2>Your {{ year }} Timeline</h2>
                    <p>Write a timeline of objectives for {{ year }}, being mindful of your current situation and areas of concern.<br>
                    Be realistic and <strong>bold</strong>. Good luck, have fun!</p>

                    {{ formset.management_form }}
                    {{ formset.non_form_errors }}

                    {% for form in formset %}

                    {% if not form.instance.pk %}
                        {% if closed_outcomes %}
                            {% for closed_outcome in closed_outcomes %}
                                <div class="breakthrough-outcome closed">
                                    <div class="breakthrough-outcome-name">
                                        <div class="grow">
                                            <input type="text" value="{{ closed_outcome.name }}" readonly disabled>
                                        </div>
                                        <div class="by">
                                            <span class="confidence-level">‚úÖ</span>
                                        </div>
                                        <div>
                                            <input type="date" value="{{ closed_outcome.resolved_by|date:'Y-m-d' }}" readonly disabled>
                                        </div>
                                        <div class="outcome-menu">
                                            <button type="button" class="menu-toggle" title="More actions">‚ãØ</button>
                                            <div class="menu-dropdown">
                                                <a href="{% url 'projected-outcome-events-history' event_stream_id=closed_outcome.event_stream_id %}" class="menu-item">
                                                    üìï View History
                                                </a>
                                            </div>
                                        </div>
                                        <button type="button" class="accordion">Open</button>
                                    </div>
                                    <div class="breakthrough-outcome-extra hidden">
                                        {% if closed_outcome.description %}
                                        <div class="field">
                                            <textarea readonly disabled>{{ closed_outcome.description }}</textarea>
                                            <div class="meta"></div>
                                        </div>
                                        {% endif %}
                                        {% if closed_outcome.success_criteria %}
                                        <div class="field">
                                            <textarea readonly disabled>{{ closed_outcome.success_criteria }}</textarea>
                                            <div class="meta">Success criteria</div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                        {% if moved_outcomes %}
                            {% for moved_outcome in moved_outcomes %}
                                <div class="breakthrough-outcome moved">
                                    <div class="breakthrough-outcome-name">
                                        <div class="grow">
                                            <input type="text" value="{{ moved_outcome.name }}" readonly disabled>
                                        </div>
                                        <div class="by">
                                            <span class="confidence-level">‚û°Ô∏è</span>
                                        </div>
                                        <div>
                                            <input type="date" value="{{ moved_outcome.resolved_by|date:'Y-m-d' }}" readonly disabled>
                                        </div>
                                        <div class="outcome-menu">
                                            <button type="button" class="menu-toggle" title="More actions">‚ãØ</button>
                                            <div class="menu-dropdown">
                                                <a href="{% url 'projected-outcome-events-history' event_stream_id=moved_outcome.event_stream_id %}" class="menu-item">
                                                    üìï View History
                                                </a>
                                            </div>
                                        </div>
                                        <button type="button" class="accordion">Open</button>
                                    </div>
                                    <div class="breakthrough-outcome-extra hidden">
                                        {% if moved_outcome.description %}
                                        <div class="field">
                                            <textarea readonly disabled>{{ moved_outcome.description }}</textarea>
                                            <div class="meta"></div>
                                        </div>
                                        {% endif %}
                                        {% if moved_outcome.success_criteria %}
                                        <div class="field">
                                            <textarea readonly disabled>{{ moved_outcome.success_criteria }}</textarea>
                                            <div class="meta">Success criteria</div>
                                        </div>
                                        {% endif %}
                                        <div class="field">
                                            <div class="meta">Confidence at move: {{ moved_outcome.confidence_level }}%</div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endif %}
                        <div class="breakthrough-outcome {% if not form.instance.pk %}empty{% endif %} {% if form.errors %}open{% endif %}">
                            

                            {{ form.id }}

                            <div class="breakthrough-outcome-name">
                                <div class="grow">{{ form.name }}</div>
                                <div class="by">
                                    {% if form.instance.confidence_level > 0 %}
                                        <span class="confidence-level">{{ form.instance.confidence_level|floatformat }}%</span>
                                    {% else %}
                                        <span class="confidence-level">by</span>
                                    {% endif %}
                                </div>
                                <div>{{ form.resolved_by }}</div>
                                {% if form.instance.pk %}
                                    <div class="outcome-menu">
                                        <button type="button" class="menu-toggle" title="More actions">‚ãØ</button>
                                        <div class="menu-dropdown">
                                            <a href="{% url 'projected-outcome-events-history' event_stream_id=form.instance.event_stream_id %}" class="menu-item">
                                                üìï View History
                                            </a>
                                            <button
                                                type="button"
                                                class="menu-item close-outcome-btn {% if form.instance.confidence_level != 100 %}disabled{% endif %}"
                                                data-outcome-id="{{ form.instance.pk }}"
                                                {% if form.instance.confidence_level != 100 %}disabled{% endif %}
                                                title="{% if form.instance.confidence_level != 100 %}Set confidence to 100% to close{% else %}Close this outcome{% endif %}">
                                                ‚úÖ Close Outcome
                                            </button>
                                            <button
                                                type="button"
                                                class="menu-item move-outcome-btn"
                                                data-outcome-id="{{ form.instance.pk }}"
                                                data-next-year="{{ year|add:'1' }}"
                                                title="Move this outcome to {{ year|add:'1' }}">
                                                ‚û°Ô∏è Move to {{ year|add:'1' }}
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="accordion">Open</button>
                                {% endif %}
                            </div>
                            <div class="breakthrough-outcome-extra {% if form.instance.pk %}hidden{% endif %}">
                                {{ form.errors.name }}
                                {{ form.errors.resolved_by }}
                                <div class="field">
                                    {{ form.description }}
                                    <div class="meta">{{ form.description.help_text }}</div>
                                </div>
                                {{ form.errors.description }}
                                <div class="field">
                                    {{ form.success_criteria }}
                                    <div class="meta">{{ form.success_criteria.help_text }}</div>
                                </div>
                                {{ form.errors.success_criteria }}
                                <div class="field">
                                    <div class="breakthrough-outcome-confidence">
                                        {{ form.confidence_level.label_tag }}
                                        {{ form.confidence_level }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                   

            </section>
            </div>
        </main>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle menu toggle
    const menuToggles = document.querySelectorAll('.menu-toggle');

    menuToggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = this.nextElementSibling;
            const isOpen = dropdown.classList.contains('show');

            // Close all other dropdowns
            document.querySelectorAll('.menu-dropdown.show').forEach(d => {
                if (d !== dropdown) d.classList.remove('show');
            });

            // Toggle current dropdown
            dropdown.classList.toggle('show');
        });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.outcome-menu')) {
            document.querySelectorAll('.menu-dropdown.show').forEach(d => {
                d.classList.remove('show');
            });
        }
    });

    // Get all close buttons
    const closeButtons = document.querySelectorAll('.close-outcome-btn');

    // Setup dynamic enable/disable based on confidence level
    closeButtons.forEach(button => {
        const outcomeDiv = button.closest('.breakthrough-outcome');
        const confidenceInput = outcomeDiv.querySelector('.breakthrough-outcome-confidence input');

        if (confidenceInput) {
            // Update button state when slider changes
            confidenceInput.addEventListener('input', function() {
                const value = parseFloat(this.value);
                if (value === 100) {
                    button.disabled = false;
                    button.classList.remove('disabled');
                    button.title = 'Close this outcome';
                } else {
                    button.disabled = true;
                    button.classList.add('disabled');
                    button.title = 'Set confidence to 100% to close';
                }
            });
        }

        // Handle close button click
        button.addEventListener('click', function(e) {
            e.preventDefault();

            if (this.disabled) return;

            const outcomeId = this.dataset.outcomeId;
            const outcomeName = outcomeDiv.querySelector('input[name*="name"]').value;

            if (!confirm(`Are you sure you want to close "${outcomeName}"? This action cannot be undone.`)) {
                return;
            }

            // Make POST request to close the outcome
            fetch(`/projected-outcome/${outcomeId}/close/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to close outcome');
            })
            .then(data => {
                // Reload the page to show updated state
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to close the outcome. Please try again.');
            });
        });
    });

    // Get all move buttons
    const moveButtons = document.querySelectorAll('.move-outcome-btn');

    moveButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();

            const outcomeId = this.dataset.outcomeId;
            const nextYear = this.dataset.nextYear;
            const outcomeDiv = this.closest('.breakthrough-outcome');
            const outcomeName = outcomeDiv.querySelector('input[name*="name"]').value;

            if (!confirm(`Are you sure you want to move "${outcomeName}" to ${nextYear}?`)) {
                return;
            }

            // Make POST request to move the outcome
            fetch(`/projected-outcome/${outcomeId}/move/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to move outcome');
            })
            .then(data => {
                // Reload the page to show updated state
                window.location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to move the outcome. Please try again.');
            });
        });
    });
});
</script>
{% endblock %}
